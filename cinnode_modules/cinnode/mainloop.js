(function (exports) {
  'use strict';

  let counter = 0;
  let id = 0;

  const mainLoop = imports.gi.GLib.MainLoop.new(null, false);
  const gjsLoop = imports.mainloop;
  const quit = function quit() {
    id = 0;
    if (counter < 1) {
      mainLoop.quit();
    }
    return false;
  };

  // exported methods
  const wait = () => {
    counter++;
  };
  const go = () => {
    if (--counter < 1) {
      if (id) {
        gjsLoop.source_remove(id);
      }
      id = gjsLoop.timeout_add(33, quit);
    }
  };
  const idle = (fn, ...args) => {
    wait();
    gjsLoop.idle_add(() => {
      go();
      fn.apply(null, args);
    });
  };
  const run = () => {
    if (!mainLoop.is_running() && 0 < counter) {
      mainLoop.run();
    }
  };

  exports.go = go;
  exports.idle = idle;
  exports.run = run;
  exports.wait = wait;

}(this));