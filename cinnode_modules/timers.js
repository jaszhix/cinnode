const Mainloop = imports.mainloop;
const cinodeLoop = process.binding('mainloop');
const ids = new Set();
const clearID = (id) => {
  if (ids.has(id)) {
    ids.delete(id);
    cinodeLoop.go();
  }
};
const createClearTimer = () => (id) => Mainloop.source_remove(id);

const createSetTimer = (repeat) => {
  (fn, ms, ...args) => {
    const id = Mainloop.timeout_add((ms * 1) || 0, () => {
      if (!repeat) {
        clearID(id);
      }
      fn.apply(null, args);
      return repeat;
    });
    ids.add(id);
    cinodeLoop.wait();
    return id;
  };
}

const timers = {
  clearInterval: createClearTimer(),
  clearTimeout: createClearTimer(),
  setInterval: createSetTimer(true),
  setTimeout: createSetTimer(false)
};

Object.defineProperties(
  global, {
    clearInterval: {
      enumerable: true,
      value: timers.clearInterval
    },
    clearTimeout: {
      enumerable: true,
      value: timers.clearTimeout
    },
    setInterval: {
      enumerable: true,
      value: timers.setInterval
    },
    setTimeout: {
      enumerable: true,
      value: timers.setTimeout
    }
  }
);

module.exports = timers;